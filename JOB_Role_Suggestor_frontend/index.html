<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Job Role Suggester</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
    <style>
        input[type="file"]::file-selector-button {
            background-color: #4f46e5; color: white; border: none; padding: 0.5rem 1rem;
            border-radius: 0.5rem; cursor: pointer; transition: background-color 0.2s;
        }
        input[type="file"]::file-selector-button:hover { background-color: #4338ca; }
        .gemini-feature-btn {
            background-color: #ede9fe; color: #5b21b6; font-weight: 600;
            padding: 0.25rem 0.75rem; border-radius: 9999px; font-size: 0.875rem;
            transition: all 0.2s; border: 1px solid #c4b5fd;
        }
        .gemini-feature-btn:hover { background-color: #d8b4fe; transform: translateY(-1px); }
    </style>
</head>
<body class="bg-slate-100 text-gray-800 font-sans flex items-center justify-center min-h-screen p-4">

    <div class="w-full max-w-2xl bg-white rounded-2xl shadow-lg p-6 md:p-8 space-y-6">
        <div class="text-center">
            <h1 class="text-3xl md:text-4xl font-bold text-indigo-600">AI Job Role Suggester</h1>
            <p class="text-gray-500 mt-2">Upload your resume (PDF) and let our secure AI find the perfect job for you.</p>
        </div>

        <div>
            <label for="resume-upload" class="block mb-2 text-sm font-medium text-gray-600">Upload Your Resume:</label>
            <input id="resume-upload" type="file" accept=".pdf" class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-indigo-600 file:text-white hover:file:bg-indigo-700 cursor-pointer">
        </div>

        <div id="status-box" class="hidden p-4 rounded-lg text-center font-medium">
            <p id="status-message"></p>
        </div>
        
        <div id="results-box" class="hidden space-y-6 pt-4 border-t border-slate-200">
            <div>
                <h2 class="text-2xl font-bold text-indigo-700">Top Prediction</h2>
                <div id="top-prediction" class="mt-2 p-4 bg-slate-50 rounded-lg border-l-4 border-indigo-500"></div>
            </div>
            <div>
                <h3 class="text-xl font-semibold text-gray-700">Extracted Skills</h3>
                <div id="extracted-skills" class="mt-2 flex flex-wrap gap-2"></div>
            </div>
            <div>
                <h3 class="text-xl font-semibold text-gray-700">Other Suggestions</h3>
                <div id="other-suggestions" class="mt-2 space-y-2"></div>
            </div>
        </div>
    </div>

    <script>
        const fileInput = document.getElementById('resume-upload');
        const statusBox = document.getElementById('status-box');
        const statusMessage = document.getElementById('status-message');
        const resultsBox = document.getElementById('results-box');
        const topPredictionEl = document.getElementById('top-prediction');
        const otherSuggestionsEl = document.getElementById('other-suggestions');
        const extractedSkillsEl = document.getElementById('extracted-skills');
        
        pdfjsLib.GlobalWorkerOptions.workerSrc = `https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js`;

        fileInput.addEventListener('change', async (event) => {
            const file = event.target.files[0];
            if (!file) return;

            resultsBox.classList.add('hidden');
            
            try {
                // Step 1: Parse the PDF in the browser
                updateStatus('Parsing your resume...', 'info');
                const resumeText = await parsePdf(file);
                console.log("PDF Parsed.");

                // Step 2: Send the text to our secure backend for all processing
                updateStatus('Sending to server for secure analysis...', 'info');
                const predictionData = await processResumeOnBackend(resumeText);
                console.log("Prediction received:", predictionData);

                // Step 3: Display the results returned from our backend
                updateStatus('Analysis Complete!', 'success');
                displaySkills(predictionData.extracted_keywords);
                displayResults(predictionData);
                setTimeout(() => statusBox.classList.add('hidden'), 2000);

            } catch (error) {
                console.error("Workflow failed:", error);
                updateStatus(`Error: ${error.message}`, 'error');
            }
        });

        function updateStatus(message, type) {
            statusBox.classList.remove('hidden', 'bg-blue-100', 'text-blue-800', 'bg-red-100', 'text-red-800', 'bg-green-100', 'text-green-800');
            statusMessage.textContent = message;
            if (type === 'info') statusBox.classList.add('bg-blue-100', 'text-blue-800');
            else if (type === 'error') statusBox.classList.add('bg-red-100', 'text-red-800');
            else if (type === 'success') statusBox.classList.add('bg-green-100', 'text-green-800');
        }

        async function parsePdf(file) {
            const fileReader = new FileReader();
            return new Promise((resolve, reject) => {
                fileReader.onload = async function() {
                    const typedarray = new Uint8Array(this.result);
                    try {
                        const pdf = await pdfjsLib.getDocument(typedarray).promise;
                        let fullText = '';
                        for (let i = 1; i <= pdf.numPages; i++) {
                            const page = await pdf.getPage(i);
                            const textContent = await page.getTextContent();
                            fullText += textContent.items.map(item => item.str).join(' ') + '\n';
                        }
                        resolve(fullText);
                    } catch (error) { reject(new Error("Could not read the PDF file.")); }
                };
                fileReader.onerror = () => reject(new Error("Failed to read the file."));
                fileReader.readAsArrayBuffer(file);
            });
        }

        async function processResumeOnBackend(text) {
            // IMPORTANT: Update this URL to your live Render URL after deployment
            const apiUrl = 'https://job-role-suggestor-api.onrender.com/api/process_resume';
            
            const response = await fetch(apiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ resume_text: text })
            });

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.detail || "Failed to process resume on the server.");
            }
            return response.json();
        }
        
        function displaySkills(keywords) {
            extractedSkillsEl.innerHTML = '';
            keywords.forEach(skill => {
                const skillTag = document.createElement('span');
                skillTag.className = 'bg-indigo-100 text-indigo-800 px-3 py-1 text-sm font-medium rounded-full';
                skillTag.textContent = skill;
                extractedSkillsEl.appendChild(skillTag);
            });
        }

        function displayResults(prediction) {
            resultsBox.classList.remove('hidden');
            
            const topRole = prediction.suggestions[0];
            topPredictionEl.innerHTML = `
                <h4 class="text-xl font-semibold text-gray-800">${topRole.role}</h4>
                <p class="text-gray-600">Confidence: <span class="font-bold text-indigo-600">${topRole.confidence}</span></p>
            `;

            otherSuggestionsEl.innerHTML = '';
            prediction.suggestions.slice(1).forEach(suggestion => {
                const suggestionDiv = document.createElement('div');
                suggestionDiv.className = 'p-3 bg-slate-50 rounded-md';
                suggestionDiv.innerHTML = `
                    <p class="font-medium text-gray-700">${suggestion.role}</p>
                    <p class="text-sm text-gray-500">Confidence: <span class="font-semibold text-indigo-500">${suggestion.confidence}</span></p>
                `;
                otherSuggestionsEl.appendChild(suggestionDiv);
            });
        }
    </script>
</body>
</html>
