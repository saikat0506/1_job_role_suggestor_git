<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Job Role Suggester</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.min.js"></script>
    <style>
        input[type="file"]::file-selector-button {
            background-color: #4f46e5; color: white; border: none; padding: 0.5rem 1rem;
            border-radius: 0.5rem; cursor: pointer; transition: background-color 0.2s;
        }
        input[type="file"]::file-selector-button:hover { background-color: #4338ca; }
        .gemini-feature-btn {
            background-color: #ede9fe; /* violet-100 */
            color: #5b21b6; /* violet-800 */
            font-weight: 600;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-size: 0.875rem;
            transition: all 0.2s;
            border: 1px solid #c4b5fd; /* violet-300 */
        }
        .gemini-feature-btn:hover {
            background-color: #d8b4fe; /* violet-200 */
            transform: translateY(-1px);
        }
    </style>
</head>
<body class="bg-slate-100 text-gray-800 font-sans flex items-center justify-center min-h-screen p-4">

    <div class="w-full max-w-2xl bg-white rounded-2xl shadow-lg p-6 md:p-8 space-y-6">
        <div class="text-center">
            <h1 class="text-3xl md:text-4xl font-bold text-indigo-600">AI Job Role Suggester</h1>
            <p class="text-gray-500 mt-2">Upload your resume (PDF) and let our secure AI find the perfect job for you.</p>
        </div>

        <div>
            <label for="resume-upload" class="block mb-2 text-sm font-medium text-gray-600">Upload Your Resume:</label>
            <input id="resume-upload" type="file" accept=".pdf" class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-indigo-600 file:text-white hover:file:bg-indigo-700 cursor-pointer">
        </div>

        <div id="status-box" class="hidden p-4 rounded-lg text-center font-medium">
            <p id="status-message"></p>
        </div>
        
        <div id="results-box" class="hidden space-y-6 pt-4 border-t border-slate-200">
            <div>
                <h2 class="text-2xl font-bold text-indigo-700">Top Prediction</h2>
                <div id="top-prediction" class="mt-2 p-4 bg-slate-50 rounded-lg border-l-4 border-indigo-500"></div>
            </div>
            <!-- New Gemini Features Section -->
            <div id="gemini-features-container" class="hidden space-y-4">
                <div>
                    <h3 class="text-xl font-semibold text-gray-700 mb-2">✨ AI-Powered Insights</h3>
                    <div class="flex flex-wrap gap-2">
                         <button id="interview-q-btn" class="gemini-feature-btn">Generate Interview Questions</button>
                         <button id="career-path-btn" class="gemini-feature-btn">Suggest Career Path</button>
                    </div>
                </div>
                <div id="gemini-output" class="p-4 bg-violet-50 rounded-lg border border-violet-200 text-sm text-gray-700 hidden"></div>
            </div>
            <div>
                <h3 class="text-xl font-semibold text-gray-700">Extracted Skills</h3>
                <div id="extracted-skills" class="mt-2 flex flex-wrap gap-2"></div>
            </div>
            <div id="second-suggestion-container" class="hidden">
                <h3 class="text-xl font-semibold text-gray-700">Second Suggestion</h3>
                <div id="second-suggestion" class="mt-2 p-3 bg-slate-50 rounded-md"></div>
            </div>
        </div>
    </div>

    <script>
        // --- JAVASCRIPT LOGIC ---
        let currentTopRole = null;
        let currentKeywords = [];

        const fileInput = document.getElementById('resume-upload');
        const statusBox = document.getElementById('status-box');
        const statusMessage = document.getElementById('status-message');
        const resultsBox = document.getElementById('results-box');
        const topPredictionEl = document.getElementById('top-prediction');
        const secondSuggestionContainer = document.getElementById('second-suggestion-container');
        const secondSuggestionEl = document.getElementById('second-suggestion');
        const extractedSkillsEl = document.getElementById('extracted-skills');
        const geminiFeaturesContainer = document.getElementById('gemini-features-container');
        const geminiOutput = document.getElementById('gemini-output');
        const interviewQBtn = document.getElementById('interview-q-btn');
        const careerPathBtn = document.getElementById('career-path-btn');
        
        pdfjsLib.GlobalWorkerOptions.workerSrc = `https://cdnjs.cloudflare.com/ajax/libs/pdf.js/2.16.105/pdf.worker.min.js`;

        fileInput.addEventListener('change', async (event) => {
            const file = event.target.files[0];
            if (!file) return;

            resultsBox.classList.add('hidden');
            geminiFeaturesContainer.classList.add('hidden');
            geminiOutput.classList.add('hidden');
            
            try {
                updateStatus('Parsing your resume...', 'info');
                const resumeText = await parsePdf(file);
                console.log("PDF Parsed.");

                updateStatus('Sending to server for secure analysis...', 'info');
                const predictionData = await processResumeOnBackend(resumeText);
                console.log("Prediction received:", predictionData);
                
                currentKeywords = predictionData.extracted_keywords;

                updateStatus('Analysis Complete!', 'success');
                displaySkills(predictionData.extracted_keywords);
                displayResults(predictionData);
                setTimeout(() => statusBox.classList.add('hidden'), 2000);

            } catch (error) {
                console.error("Workflow failed:", error);
                updateStatus(`Error: ${error.message}`, 'error');
            }
        });

        // --- Event Listeners for New Gemini Features ---
        interviewQBtn.addEventListener('click', async () => {
            if (!currentTopRole) return;
            geminiOutput.innerHTML = '<p>✨ Generating interview questions...</p>';
            geminiOutput.classList.remove('hidden');
            try {
                const questions = await getInterviewQuestions(currentTopRole);
                geminiOutput.innerHTML = questions;
            } catch (error) {
                geminiOutput.innerHTML = `<p class="text-red-600">Error: ${error.message}</p>`;
            }
        });

        careerPathBtn.addEventListener('click', async () => {
            if (!currentTopRole || currentKeywords.length === 0) return;
            geminiOutput.innerHTML = '<p>✨ Suggesting a potential career path...</p>';
            geminiOutput.classList.remove('hidden');
            try {
                const path = await getCareerPath(currentTopRole, currentKeywords);
                geminiOutput.innerHTML = path;
            } catch (error) {
                geminiOutput.innerHTML = `<p class="text-red-600">Error: ${error.message}</p>`;
            }
        });


        // --- Helper Functions ---
        function updateStatus(message, type) {
            statusBox.classList.remove('hidden', 'bg-blue-100', 'text-blue-800', 'bg-red-100', 'text-red-800', 'bg-green-100', 'text-green-800');
            statusMessage.textContent = message;
            if (type === 'info') statusBox.classList.add('bg-blue-100', 'text-blue-800');
            else if (type === 'error') statusBox.classList.add('bg-red-100', 'text-red-800');
            else if (type === 'success') statusBox.classList.add('bg-green-100', 'text-green-800');
        }

        async function parsePdf(file) {
            const fileReader = new FileReader();
            return new Promise((resolve, reject) => {
                fileReader.onload = async function() {
                    const typedarray = new Uint8Array(this.result);
                    try {
                        const pdf = await pdfjsLib.getDocument(typedarray).promise;
                        let fullText = '';
                        for (let i = 1; i <= pdf.numPages; i++) {
                            const page = await pdf.getPage(i);
                            const textContent = await page.getTextContent();
                            fullText += textContent.items.map(item => item.str).join(' ') + '\n';
                        }
                        resolve(fullText);
                    } catch (error) { reject(new Error("Could not read the PDF file.")); }
                };
                fileReader.onerror = () => reject(new Error("Failed to read the file."));
                fileReader.readAsArrayBuffer(file);
            });
        }
        
        async function callGeminiAPI(prompt) {
            // NOTE: This function is a SIMULATION.
            // In a real deployed application, you would create new endpoints on your
            // backend (e.g., /api/interview-questions) that would securely call the
            // Gemini API. The frontend would then call those new endpoints.
            
            console.log("Simulating Gemini API call with prompt:", prompt);
            
            // Simulate network delay
            await new Promise(resolve => setTimeout(resolve, 1500));

            if (prompt.includes("interview questions")) {
                return `
                    <h4>Interview Questions for ${currentTopRole}</h4>
                    <ul>
                        <li class="mt-2"><b>Behavioral:</b> "Can you describe a time you had to learn a new technology quickly for a project?"</li>
                        <li class="mt-2"><b>Technical:</b> "What are the core principles of object-oriented programming?"</li>
                        <li class="mt-2"><b>Situational:</b> "Imagine you discover a critical bug right before a major release. What are your immediate next steps?"</li>
                        <li class="mt-2">"How do you stay updated with the latest industry trends?"</li>
                        <li class="mt-2">"What is your approach to collaborating with a team on a large codebase?"</li>
                    </ul>
                `;
            } else if (prompt.includes("career path")) {
                 return `
                    <p>Based on your skills and the role of <b>${currentTopRole}</b>, a logical next step would be to aim for a Senior or Lead position. To advance, consider developing skills in these key areas:</p>
                    <ul>
                        <li class="mt-2"><b>System Design & Architecture:</b> To lead larger projects.</li>
                        <li class="mt-2"><b>Mentorship & Leadership:</b> To guide junior members of the team.</li>
                        <li class="mt-2"><b>Cloud Cost Optimization:</b> To manage resources effectively at scale.</li>
                    </ul>
                `;
            }
            return "Could not generate a response.";
        }
        
        // --- New Gemini Feature Functions ---
        async function getInterviewQuestions(role) {
            const prompt = `You are an expert career coach. Generate a list of 5 common and insightful interview questions for a "${role}" position. Include one behavioral question, one technical question, and one situational question. Format the response as an HTML unordered list.`;
            return await callGeminiAPI(prompt);
        }

        async function getCareerPath(role, skills) {
            const prompt = `You are a helpful career advisor. Based on the job role "${role}" and the skills [${skills.join(', ')}], suggest a potential career path. What is a logical next step or a more senior role? What 2-3 key skills should this person learn to get there? Format the response as a short paragraph followed by an HTML unordered list for the skills.`;
            return await callGeminiAPI(prompt);
        }

        async function processResumeOnBackend(text) {
            const apiUrl = 'https://job-role-suggestor-api.onrender.com/api/process_resume';
            
            const response = await fetch(apiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ resume_text: text })
            });

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.detail || "Failed to process resume on the server.");
            }
            return response.json();
        }
        
        function displaySkills(keywords) {
            extractedSkillsEl.innerHTML = '';
            keywords.forEach(skill => {
                const skillTag = document.createElement('span');
                skillTag.className = 'bg-indigo-100 text-indigo-800 px-3 py-1 text-sm font-medium rounded-full';
                skillTag.textContent = skill;
                extractedSkillsEl.appendChild(skillTag);
            });
        }

        function displayResults(prediction) {
            resultsBox.classList.remove('hidden');
            
            currentTopRole = prediction.suggestions[0].role;
            
            topPredictionEl.innerHTML = `
                <h4 class="text-xl font-semibold text-gray-800">${currentTopRole}</h4>
                <p class="text-gray-600">Confidence: <span class="font-bold text-indigo-600">${prediction.suggestions[0].confidence}</span></p>
            `;

            if (prediction.suggestions.length > 1) {
                const secondRole = prediction.suggestions[1];
                secondSuggestionEl.innerHTML = `
                    <p class="font-medium text-gray-700">${secondRole.role}</p>
                    <p class="text-sm text-gray-500">Confidence: <span class="font-semibold text-indigo-500">${secondRole.confidence}</span></p>
                `;
                secondSuggestionContainer.classList.remove('hidden');
            } else {
                secondSuggestionContainer.classList.add('hidden');
            }

            geminiFeaturesContainer.classList.remove('hidden');
        }
    </script>
</body>
</html>
